# RovLink ISA标准

RovLink的应用层通用消息以**标准ISA**（Instruction Structure Architecture，指令集架构）的形式组织。标准ISA包含了大多数对水下机器人控制和机器人智能控制有用的功能。虽然RovLink提供了扩展指令子集供用户自定义指令帧，但推荐用户遵循RovLink标准ISA来实现自己机器人必要的控制功能，将被CoralReef上位机及其他生态软件兼容。

标准ISA包括16个指令子集，扩展指令子集被视为标准ISA的一部分——**每个指令帧Opcode中的高四位表明本帧对应的指令子集**，低四位决定本帧的具体类型。后面会以Opcode从0x00到0xF0的顺序对指令子集进行说明

> [!WARNING]
>
> RovLink中的DLC字段已经被弃用，本文档中**推荐使用的DLC**只作为数据类型的语义标识

RovLink要求设备能够向控制台返回一些必要的数据，并至少能够接受一部分控制指令，这些指令组成了**RovLink核心指令集**。一旦设备满足核心指令集的要求，便可以使用CoralReef上位机软件对基础数据进行接收和发送测试指令。RovLink不强制规定核心指令集外的Opcode使用，但为兼容性考虑，推荐开发者遵循下面所说的帧数据类型约定。同时，若开发者需要定义自己的指令，也可以有效利用三个扩展指令子集

## 0x00 普通数据

普通数据子集包含机器人需要回传的最基础的数据。**要求支持RovLink的设备应当至少能够传输Opcode为 `0x01` 到 `0x06` 的数据类型**

普通数据子集提供的类型如下

| Opcode   | 类型描述                                       | 帧特性     | 推荐使用的DLC |
| -------- | ---------------------------------------------- | ---------- | ------------- |
| 0x00     | 空数据，Payload始终为0                         | 回传帧     | 2'b00         |
| **0x01** | **舱内温度、舱内湿度、舱内气压**               | **回传帧** | **2'b11**     |
| **0x02** | **水温、水深、水压（环境温度、湿度、大气压）** | **回传帧** | **2'b11**     |
| **0x03** | **XYZ轴加速度**                                | **回传帧** | **2'b11**     |
| **0x04** | **XYZ轴角速度**                                | **回传帧** | **2'b11**     |
| **0x05** | **XYZ轴欧拉角**                                | **回传帧** | **2'b11**     |
| **0x06** | **XYZ轴地磁强度**                              | **回传帧** | **2'b11**     |
| 0x07     | 高度声呐返回值和置信度                         | 回传帧     | 2‘b10         |
| 0x08     | 测距声呐返回值和置信度                         | 回传帧     | 2'b10         |
| 0x09     | 环形声呐返回值和对应声呐扫描位置               | 回传帧     | 2'b10         |
| 0x0A     | 侧扫声呐返回值和对应声呐扫描位置               | 回传帧     | 2'b10         |
| 0x0B     | 四元数值和归属w、x、y、z中的哪一个             | 回传帧     | 2'b10         |
| 0x0C     | 水体盐度、浑浊度、光照度                       | 回传帧     | 2'b11         |
| 0x0D     | 保留                                           | 回传帧     | 2'b11         |
| 0x0E     | 保留                                           | 回传帧     | 保留          |
| 0x0F     | 保留                                           | 回传帧     | 保留          |

下面分别给出每种数据的存储格式和解算方法

### 0x00

| 数据功能 | 空     | 空     | 空     |
| -------- | ------ | ------ | ------ |
| 数值范围 | 0x0000 | 0x0000 | 0x0000 |

### 0x01

| 数据功能 | 舱内温度           | 舱内相对湿度        | 舱内气压              |
| -------- | ------------------ | ------------------- | --------------------- |
| 数值范围 | int16_t，单位0.01℃ | uint16_t，单位0.01% | uint16_t，单位0.01kPa |

### 0x02

| 数据功能 | 水温/环境温度      | 水深/环境湿度              | 水压/大气压           |
| -------- | ------------------ | -------------------------- | --------------------- |
| 数值范围 | int16_t，单位0.01℃ | uint16_t，单位0.01m或0.01% | uint16_t，单位0.01kPa |

### 0x03

| 数据功能 | X轴加速度              | Y轴加速度              | Z轴加速度              |
| -------- | ---------------------- | ---------------------- | ---------------------- |
| 数值范围 | int16_t，单位0.01m/s^2 | int16_t，单位0.01m/s^2 | int16_t，单位0.01m/s^2 |

### 0x04

| 数据功能 | X轴速度              | Y轴速度              | Z轴速度              |
| -------- | -------------------- | -------------------- | -------------------- |
| 数值范围 | int16_t，单位0.01m/s | int16_t，单位0.01m/s | int16_t，单位0.01m/s |

### 0x05

| 数据功能 | 横滚角Roll         | 俯仰角Pitch        | 航向角Yaw          |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | int16_t，单位0.01° | int16_t，单位0.01° | int16_t，单位0.01° |

### 0x06

| 数据功能 | X轴磁场强度          | Y轴磁场强度          | Z轴磁场强度          |
| -------- | -------------------- | -------------------- | -------------------- |
| 数值范围 | int16_t，单位0.01A/m | int16_t，单位0.01A/m | int16_t，单位0.01A/m |

### 0x07

| 数据功能 | 高度声呐返回值      | 置信度             |
| -------- | ------------------- | ------------------ |
| 数值范围 | uint32_t，单位0.01m | 0-10000，单位0.01% |

### 0x08

| 数据功能 | 测距声呐返回值      | 置信度             |
| -------- | ------------------- | ------------------ |
| 数值范围 | uint32_t，单位0.01m | 0-10000，单位0.01% |

### 0x09

| 数据功能 | 环形声呐返回值      | 扫描点序号          |
| -------- | ------------------- | ------------------- |
| 数值范围 | uint32_t，单位0.01m | uint16_t，单位0.01m |

### 0x0A

| 数据功能 | 侧扫声呐返回值      | 扫描坐标            |
| -------- | ------------------- | ------------------- |
| 数值范围 | uint32_t，单位0.01m | uint16_t，单位0.01m |

### 0x0B

| 数据功能 | 四元数    | w、x、y、z                     |
| -------- | --------- | ------------------------------ |
| 数值范围 | float32_t | 0x01:w; 0x02:x; 0x04:y; 0x08:z |

### 0x0C

| 数据功能 | 水体盐度            | 水体浑浊度          | 水体光照度          |
| -------- | ------------------- | ------------------- | ------------------- |
| 数值范围 | uint16_t，单位0.01% | uint16_t，单位0.01% | uint16_t，单位0.01m |

### 0x0D

| 数据功能 | 保留 | 保留 | 保留 |
| -------- | ---- | ---- | ---- |
| 数值范围 | 保留 | 保留 | 保留 |



## 0x10 特殊数据

特殊数据子集包含心跳包和漏水指示等关键信息。**要求支持RovLink的设备应当至少能够传输Opcode为 `0x10` 到 `0x11` 的数据类型**

特殊数据子集提供的类型如下

| Opcode   | 类型描述                     | 帧特性     | 推荐使用的DLC |
| -------- | ---------------------------- | ---------- | ------------- |
| **0x10** | **漏水指示**                 | **回传帧** | **2'b00**     |
| **0x11** | **时间戳和当前设备工作状态** | **心跳包** | **2'b10**     |
| 0x12     |                              |            |               |
| 0x13     |                              |            |               |
| 0x14     |                              |            |               |
| 0x15     |                              |            |               |
| 0x16     |                              |            |               |
| 0x17     |                              |            |               |
| 0x18     |                              |            |               |
| 0x19     |                              |            |               |
| 0x1A     |                              |            |               |
| 0x1B     |                              |            |               |
| 0x1C     |                              |            |               |
| 0x1D     |                              |            |               |
| 0x1E     |                              |            |               |
| 0x1F     | OTA数据                      | 功能帧     | 2'b01         |

下面分别给出每种数据的存储格式和解算方法

### 0x10

| 数据功能 | 漏水指示 | 漏水指示 | 漏水指示 | 漏水指示 | 漏水指示 | 漏水指示 |
| -------- | -------- | -------- | -------- | -------- | -------- | -------- |
| 数值范围 | uint8_t  | uint8_t  | uint8_t  | uint8_t  | uint8_t  | uint8_t  |

漏水指示一般以位标记，如果漏水传感器报警，则将对应位置为1，否则为0，方便指示多点漏水情况

### 0x11

| 数据功能 | 时间戳   | 时间戳扩展 |
| -------- | -------- | ---------- |
| 数值范围 | uint32_t | uint16_t   |

时间戳为UNIX时间戳（单位秒）或RTOS系统时钟（单位毫秒）计数截取后32位。具体使用秒单位还是毫秒单位，需要根据DLC的值决定

下表给出了DLC值与本帧解析方式的关系

| DLC值    | 时间戳                         | 时间戳扩展                     |
| -------- | ------------------------------ | ------------------------------ |
| 数值范围 | uint32_t                       | uint16_t                       |
| 2'b10    | UNIX时间戳（单位秒）           | 心跳包超时标志                 |
| 2'b01    | RTOS系统时钟（单位毫秒）低32位 | RTOS系统时钟（单位毫秒）高16位 |

毫秒时间戳：该位为1时，则时间戳单位为毫秒；该位为0，则时间戳单位为秒

心跳包超时标志：只有当DLC=2时有效。如果触发心跳包超时，该字段为1；如果当前设备正常工作，字段为0

### 0x1F

| 数据功能 | OTA数据               | CRC16                            |
| -------- | --------------------- | -------------------------------- |
| 数值范围 | 存放32位对齐的OTA数据 | uint16_t，对OTA数据的CRC16校验码 |



## 0x20 控制指令

控制指令子集包含机器人控制的基础指令。**要求支持RovLink的设备应当至少能够传输Opcode为 `0x21` 、 `0x25` 、 `0x27` 、 `0x28` 、`0x2B` 的指令**

控制指令子集提供的类型如下

| Opcode   | 类型描述                                                    | 帧特性     | 推荐使用的DLC |
| -------- | ----------------------------------------------------------- | ---------- | ------------- |
| 0x20     | 保留                                                        | 指令帧     | 2'b11         |
| **0x21** | **推进器组A控制**                                           | **指令帧** | **2'b11**     |
| 0x22     | 推进器组B控制                                               | 指令帧     | 2'b11         |
| 0x23     | 推进器组C控制                                               | 指令帧     | 2'b11         |
| 0x24     | 推进器组D控制                                               | 指令帧     | 2'b11         |
| **0x25** | **照明组A控制**                                             | **指令帧** | **2'b11**     |
| 0x26     | 照明组B控制                                                 | 指令帧     | 2'b11         |
| **0x27** | **XYZ三轴云台控制**                                         | **指令帧** | **2'b11**     |
| **0x28** | **舵机组A控制**                                             | **指令帧** | **2'b11**     |
| 0x29     | 舵机组B控制                                                 | 指令帧     | 2'b11         |
| 0x2A     | 舵机组C控制                                                 | 指令帧     | 2'b11         |
| **0x2B** | **姿态开环控制（前进后退、左右转向、上升下降/上浮下潜）**   | **指令帧** | **2'b11**     |
| 0x2C     | 运动闭环控制（X轴角速度闭环，Y轴角速度闭环，Z轴角速度闭环） | 指令帧     | 2'b11         |
| 0x2D     | 方向闭环控制（俯仰角、横滚角、航向角）                      | 指令帧     | 2'b11         |
| 0x2E     | 保留                                                        | 指令帧     | 保留          |
| 0x2F     | 保留                                                        | 指令帧     | 保留          |

下面分别给出每种数据的存储格式和解算方法

### 0x20

| 数据功能 | 保留     | 保留     | 保留     |
| -------- | -------- | -------- | -------- |
| 数值范围 | uint16_t | uint16_t | uint16_t |

### 0x21

推进器组A控制

| 数据功能 | 推进器A1           | 推进器A2           | 推进器A3           |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x22

推进器组B控制

| 数据功能 | 推进器B1           | 推进器B1           | 推进器B1           |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x23

| 数据功能 | 推进器C1           | 推进器C1           | 推进器C1           |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x24

| 数据功能 | 推进器D1           | 推进器D1           | 推进器D1           |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x25

| 数据功能 | 照明A1   | 照明A2   | 照明A3   |
| -------- | -------- | -------- | -------- |
| 数值范围 | uint16_t | uint16_t | uint16_t |

### 0x26

| 数据功能 | 照明B1   | 照明B2   | 照明B3   |
| -------- | -------- | -------- | -------- |
| 数值范围 | uint16_t | uint16_t | uint16_t |

### 0x27

| 数据功能 | X轴云台            | Y轴云台            | Z轴云台            |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x28

| 数据功能 | 舵机A1             | 舵机A2             | 舵机A3             |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x29

| 数据功能 | 舵机B1             | 舵机B2             | 舵机B3             |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x2A

| 数据功能 | 舵机C1             | 舵机C2             | 舵机C3             |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，500-2500 | uint16_t，500-2500 | uint16_t，500-2500 |

### 0x2B

| 数据功能 | 前进后退 | 左右转向 | 上浮下潜/上升下降 |
| -------- | -------- | -------- | ----------------- |
| 数值范围 | uint16_t | uint16_t | uint16_t          |

> 类似穿越机姿态模式控制

### 0x2C

| 数据功能 | X轴角速度闭环           | Y轴角速度闭环           | Z轴角速度闭环           |
| -------- | ----------------------- | ----------------------- | ----------------------- |
| 数值范围 | uint16_t，单位0.01rad/s | uint16_t，单位0.01rad/s | uint16_t，单位0.01rad/s |

> 类似穿越机增稳模式控制

### 0x2D

| 数据功能 | 俯仰角度Pitch       | 横滚角度Roll        | 航向角度Yaw         |
| -------- | ------------------- | ------------------- | ------------------- |
| 数值范围 | uint16_t，单位0.01° | uint16_t，单位0.01° | uint16_t，单位0.01° |

> 类似穿越机自稳模式控制



## 0x30 控制台

控制台子集包含控制台内部所需的辅助数据。本指令子集没有任何指令包含在核心指令集内

控制台子集提供的类型如下

| Opcode | 类型描述   | 帧特性 | 推荐使用的DLC |
| ------ | ---------- | ------ | ------------- |
| 0x30   | 保留       | 功能帧 | 保留          |
| 0x31   | 摄像头切换 | 功能帧 | 2'b00         |
| 0x32   |            |        |               |
| 0x33   |            |        |               |
| 0x34   |            |        |               |
| 0x35   |            |        |               |
| 0x36   |            |        |               |
| 0x37   |            |        |               |
| 0x38   |            |        |               |
| 0x39   |            |        |               |
| 0x3A   |            |        |               |
| 0x3B   |            |        |               |
| 0x3C   |            |        |               |
| 0x3D   |            |        |               |
| 0x3E   |            |        |               |
| 0x3F   |            |        |               |

下面分别给出每种数据的存储格式和解算方法

> TODO



## 0x40 基础算法参数

基础算法参数子集包含用于向机器人传递控制算法参数（调参）或机器人向上位机回传当前算法参数所需的数据类型。本指令子集没有任何指令包含在核心指令集内

基础算法参数子集提供的类型如下

| Opcode | 类型描述                      | 帧特性        | 推荐使用的DLC |
| ------ | ----------------------------- | ------------- | ------------- |
| 0x40   | 保留                          | 指令帧        | 保留          |
| 0x41   | PID-Kp参数和归属的PID环路代号 | 指令帧/状态帧 | 2'b10         |
| 0x42   | PID-Ki参数和归属的PID环路代号 | 指令帧/状态帧 | 2'b10         |
| 0x43   | PID-Kd参数和归属的PID环路代号 | 指令帧/状态帧 | 2'b10         |
| 0x44   | 动力矩阵偏移量三元组          | 指令帧/状态帧 | 2'b11         |
| 0x45   | 动力矩阵权重三元组            | 指令帧/状态帧 | 2'b11         |
| 0x46   |                               |               |               |
| 0x47   |                               |               |               |
| 0x48   |                               |               |               |
| 0x49   |                               |               |               |
| 0x4A   |                               |               |               |
| 0x4B   |                               |               |               |
| 0x4C   |                               |               |               |
| 0x4D   |                               |               |               |
| 0x4E   |                               |               |               |
| 0x4F   |                               |               |               |

下面分别给出每种数据的存储格式和解算方法

### 0x40

| 数据功能 | 保留 | 保留 | 保留 |
| -------- | ---- | ---- | ---- |
| 数值范围 | 保留 | 保留 | 保留 |

### 0x41

| 数据功能 | PID-Kp参数 | PID环路代号 |
| -------- | ---------- | ----------- |
| 数值范围 | float_t    | uint16_t    |

RovLink推荐（默认）的PID环路代号分配如下

| PID环路代号 | PID-Kp环路   |
| ----------- | ------------ |
| 0           | 预留         |
| 1           | 自稳电流环   |
| 2           | 自稳角速度环 |
| 3           | 自稳角度环   |
| 4           | 自稳速度环   |
| 5           | 自稳位置环   |
| 6           | 预留         |
| 7           | 预留         |
| 8           | 预留         |

其余环路代号可由用户自行分配

### 0x42

| 数据功能 | PID-Ki参数 | PID环路代号 |
| -------- | ---------- | ----------- |
| 数值范围 | float_t    | uint16_t    |

RovLink推荐（默认）的PID环路代号分配如下

| PID环路代号 | PID-Ki环路   |
| ----------- | ------------ |
| 0           | 预留         |
| 1           | 自稳电流环   |
| 2           | 自稳角速度环 |
| 3           | 自稳角度环   |
| 4           | 自稳速度环   |
| 5           | 自稳位置环   |
| 6           | 预留         |
| 7           | 预留         |
| 8           | 预留         |

其余环路代号可由用户自行分配

### 0x43

| 数据功能 | PID-Kd参数 | PID环路代号 |
| -------- | ---------- | ----------- |
| 数值范围 | float_t    | uint16_t    |

RovLink推荐（默认）的PID环路代号分配如下

| PID环路代号 | PID-Ki环路   |
| ----------- | ------------ |
| 0           | 预留         |
| 1           | 自稳电流环   |
| 2           | 自稳角速度环 |
| 3           | 自稳角度环   |
| 4           | 自稳速度环   |
| 5           | 自稳位置环   |
| 6           | 预留         |
| 7           | 预留         |
| 8           | 预留         |

其余环路代号可由用户自行分配

### 0x44

该帧用于指定动力矩阵的偏移量参数 bias

| 数据功能 | 动力矩阵行坐标 Row | 动力矩阵列坐标 Col | 动力矩阵值 |
| -------- | ------------------ | ------------------ | ---------- |
| 数值范围 | uint16_t           | uint16_t           | int16_t    |

### 0x45

该帧用于指定动力矩阵的权重参数 alpha

| 数据功能 | 动力矩阵行坐标 Row | 动力矩阵列坐标 Col | 动力矩阵值 |
| -------- | ------------------ | ------------------ | ---------- |
| 数值范围 | uint16_t           | uint16_t           | int16_t    |

## 0x50 机体状态

机体状态子集包含当前机器人所处的物理状态参数回报数据。本指令子集没有任何指令包含在核心指令集内

机体状态子集提供的类型如下

| Opcode | 类型描述          | 帧特性 | 推荐使用的DLC |
| ------ | ----------------- | ------ | ------------- |
| 0x50   | 保留              | 状态帧 | 保留          |
| 0x51   | 环境状态参数      | 回传帧 | 2'b11         |
| 0x52   | XYZ速度状态参数   | 回传帧 | 2'b11         |
| 0x53   | XYZ位移状态参数   | 回传帧 | 2'b11         |
| 0x54   | 机械臂状态参数组A | 状态帧 | 2'b10         |
| 0x55   | 机械臂状态参数组B | 状态帧 | 2'b10         |
| 0x56   |                   |        |               |
| 0x57   |                   |        |               |
| 0x58   |                   |        |               |
| 0x59   |                   |        |               |
| 0x5A   |                   |        |               |
| 0x5B   |                   |        |               |
| 0x5C   |                   |        |               |
| 0x5D   |                   |        |               |
| 0x5E   |                   |        |               |
| 0x5F   |                   |        |               |

下面分别给出每种数据的存储格式和解算方法

### 0x50

| 数据功能 | 保留 | 保留 | 保留 |
| -------- | ---- | ---- | ---- |
| 数值范围 | 保留 | 保留 | 保留 |

### 0x51

| 数据功能 | 经度坐标 | 纬度坐标 | 海拔            |
| -------- | -------- | -------- | --------------- |
| 数值范围 | uint16_t | uint16_t | int16_t，单位1m |

### 0x52

| 数据功能 | X轴估计速度            | Y轴估计速度            | Z轴估计速度            |
| -------- | ---------------------- | ---------------------- | ---------------------- |
| 数值范围 | uint16_t，单位0.001m/s | uint16_t，单位0.001m/s | uint16_t，单位0.001m/s |

### 0x53

| 数据功能 | X轴估计距起始点位移 | Y轴估计距起始点位移 | Z轴估计距起始点位移 |
| -------- | ------------------- | ------------------- | ------------------- |
| 数值范围 | uint16_t，单位0.1m  | uint16_t，单位0.1m  | uint16_t，单位0.1m  |

### 0x54

| 数据功能 | 机械臂状态参数A | 参数矩阵坐标 |
| -------- | --------------- | ------------ |
| 数值范围 | float_t         | uint16_t     |

### 0x55

| 数据功能 | 机械臂状态参数B | 参数矩阵坐标 |
| -------- | --------------- | ------------ |
| 数值范围 | float_t         | uint16_t     |



## 0x60 特殊硬件控制指令

特殊硬件控制指令子集包含对特殊扩展模块的控制指令，如数控电源、特殊外设、计算加速模块等等。本指令子集没有任何指令包含在核心指令集内

特殊硬件控制指令子集提供的类型如下

| Opcode | 类型描述 | 帧特性 | 推荐使用的DLC |
| ------ | -------- | ------ | ------------- |
| 0x60   | 保留     | 指令帧 | 保留          |
| 0x61   | 外设使能 | 指令帧 | 2'b00         |
| 0x62   | 作业模块 | 指令帧 | 2'b00         |
| 0x63   |          |        |               |
| 0x64   |          |        |               |
| 0x65   |          |        |               |
| 0x66   |          |        |               |
| 0x67   |          |        |               |
| 0x68   |          |        |               |
| 0x69   |          |        |               |
| 0x6A   |          |        |               |
| 0x6B   |          |        |               |
| 0x6C   |          |        |               |
| 0x6D   |          |        |               |
| 0x6E   |          |        |               |
| 0x6F   |          |        |               |

下面分别给出每种数据的存储格式和解算方法

### 0x61

| 数据功能 | 定位激光使能 | 机械手使能 | 机械臂使能 | 主声呐使能 | 全部推进器使能 | 三轴云台使能 |
| -------- | ------------ | ---------- | ---------- | ---------- | -------------- | ------------ |
| 数值范围 | uint8_t      | uint8_t    | uint8_t    | uint8_t    | uint8_t        | uint8_t      |

使能位0表示不开启，1表示开启

### 0x62

| 数据功能 | 主作业模块 | 作业模块电机组A | 作业模块电机组B | 作业模块电机组C | 作业模块电机组D | 作业模块模式切换 |
| -------- | ---------- | --------------- | --------------- | --------------- | --------------- | ---------------- |
| 数值范围 | uint8_t    | uint8_t         | uint8_t         | uint8_t         | uint8_t         | uint8_t          |



## 0x70 模式切换指令

模式切换指令子集包含对机器人作业模式进行基本控制的指令数据。**要求支持RovLink的设备应当至少能够传输Opcode为 `0x71` 的指令**

模式切换指令子集提供的类型如下

| Opcode   | 类型描述      | 帧特性     | 推荐使用的DLC |
| -------- | ------------- | ---------- | ------------- |
| 0x70     | 保留          | 指令帧     | 保留          |
| **0x71** | **模式切换A** | **指令帧** | **2'b00**     |
| 0x72     | 模式切换B     | 指令帧     | 2'b00         |
| 0x73     | 模式切换C     | 指令帧     | 2'b00         |
| 0x74     |               |            |               |
| 0x75     |               |            |               |
| 0x76     |               |            |               |
| 0x77     |               |            |               |
| 0x78     |               |            |               |
| 0x79     |               |            |               |
| 0x7A     |               |            |               |
| 0x7B     |               |            |               |
| 0x7C     |               |            |               |
| 0x7D     |               |            |               |
| 0x7E     |               |            |               |
| 0x7F     |               |            |               |

下面分别给出每种数据的存储格式和解算方法

### 0x71

| 数据功能 | 侧推模式 | 俯仰模式 | 横滚模式 | 辅助模式 | 救援模块工作模式 | 子模块工作模式 |
| -------- | -------- | -------- | -------- | -------- | ---------------- | -------------- |
| 数值范围 | uint8_t  | uint8_t  | uint8_t  | uint8_t  | uint8_t          | uint8_t        |

侧推模式即艏摇、XY轴平移模式切换

俯仰模式即上升下降、俯仰角调节模式切换

横滚模式即艏摇、横滚角调节模式切换

辅助模式即启用机内计算模块进行辅助控制，只有当进入辅助模式时，才允许机器人自主运行

救援模块工作模式即启用救援作业模块

子模块工作模式即启用无人机子系统

### 0x72

| 数据功能 | 航向保持 | 深度保持 | 姿态稳定 | 自主航线规划 | 自主作业 | 主动避障与导航 |
| -------- | -------- | -------- | -------- | ------------ | -------- | -------------- |
| 数值范围 | uint8_t  | uint8_t  | uint8_t  | uint8_t      | uint8_t  | uint8_t        |

航向保持开启后应当使机器人的航向角保持稳定

深度保持开启后应当使机器人的航行深度保持稳定

姿态稳定开启后应当使机器人的航向角（Yaw）、俯仰角（Pitch）和横滚角（Roll）均保持稳定

自主航线规划开启后，机器人受到机载计算模块或预编程航线的控制完成巡航工作

自主作业开启后，机器人完全受到机载计算模块或预编程指令的控制完成自主作业

主动避障开启后，机器人可在运动时微调路径实现避障，如果前方出现难以绕过的障碍物，机器人应当减速并保持静止状态，适当提示用户进行手动避障

### 0x73

| 数据功能 | 运动方式切换 | 环境监测模式 | 自动下潜 | 自动上浮 | 水下定点 | 水面定点 |
| -------- | ------------ | ------------ | -------- | -------- | -------- | -------- |
| 数值范围 | uint8_t      | uint8_t      | uint8_t  | uint8_t  | uint8_t  | uint8_t  |



## 0x80 额外控制指令

额外控制指令子集是控制指令子集的扩展，包含有关作业的控制指令数据。**要求支持RovLink的设备应当至少能够传输Opcode为 `0x81` 到 `0x82` 的指令**

额外控制指令子集提供的类型如下

| Opcode   | 类型描述                   | 帧特性     | 推荐使用的DLC |
| -------- | -------------------------- | ---------- | ------------- |
| 0x80     | 保留                       | 指令帧     | 保留          |
| **0x81** | **机械手夹爪、悬腕、升降** | **指令帧** | **2'b11**     |
| **0x82** | **机械臂组A**              | **指令帧** | **2'b11**     |
| 0x83     | 机械臂组B                  | 指令帧     | 2'b11         |
| 0x84     | 机械臂组C                  | 指令帧     | 2'b11         |
| 0x85     |                            |            |               |
| 0x86     |                            |            |               |
| 0x87     |                            |            |               |
| 0x88     |                            |            |               |
| 0x89     |                            |            |               |
| 0x8A     |                            |            |               |
| 0x8B     |                            |            |               |
| 0x8C     |                            |            |               |
| 0x8D     |                            |            |               |
| 0x8E     |                            |            |               |
| 0x8F     |                            |            |               |

下面分别给出每种数据的存储格式和解算方法

### 0x81

| 数据功能 | 机械手夹爪 | 机械手旋腕 | 机械手升降 |
| -------- | ---------- | ---------- | ---------- |
| 数值范围 | uint16_t   | uint16_t   | uint16_t   |

### 0x82

| 数据功能 | 机械臂A1 | 机械臂A2 | 机械臂A3 |
| -------- | -------- | -------- | -------- |
| 数值范围 | uint16_t | uint16_t | uint16_t |

### 0x83

| 数据功能 | 机械臂B1 | 机械臂B2 | 机械臂B3 |
| -------- | -------- | -------- | -------- |
| 数值范围 | uint16_t | uint16_t | uint16_t |

### 0x84

| 数据功能 | 机械臂C1 | 机械臂C2 | 机械臂C3 |
| -------- | -------- | -------- | -------- |
| 数值范围 | uint16_t | uint16_t | uint16_t |



## 0x90 请求指令

请求指令子集包含控制台对机器人发起数据返回请求使用的指令帧。本指令子集没有任何指令包含在核心指令集内

请求指令子集提供的类型如下

| Opcode | 类型描述 | 帧特性 | 推荐使用的DLC |
| ------ | -------- | ------ | ------------- |
| 0x90   | 保留     | 指令帧 | 保留          |
| 0x91   |          |        |               |
| 0x92   |          |        |               |
| 0x93   |          |        |               |
| 0x94   |          |        |               |
| 0x95   |          |        |               |
| 0x96   |          |        |               |
| 0x97   |          |        |               |
| 0x98   |          |        |               |
| 0x99   |          |        |               |
| 0x9A   |          |        |               |
| 0x9B   |          |        |               |
| 0x9C   |          |        |               |
| 0x9D   |          |        |               |
| 0x9E   |          |        |               |
| 0x9F   |          |        |               |

下面分别给出每种数据的存储格式和解算方法

## 0xA0 电池数据

电池数据子集包含机器人电池管理系统（BMS）返回数据和控制数据。**要求支持RovLink的设备应当至少能够回传Opcode为 `0xA0` 的数据类型**

电池数据子集提供的类型如下

| Opcode   | 类型描述                             | 帧特性     | 推荐使用的DLC |
| -------- | ------------------------------------ | ---------- | ------------- |
| **0xA0** | **电池组电压、输出功率、累计耗电量** | **回传帧** | **2'b11**     |
| 0xA1     | 设置电压校准                         | 指令帧     | 2'b10         |
| 0xA2     | 设置电流校准                         | 指令帧     | 2'b10         |
| 0xA3     | 输出电流组A                          | 状态帧     | 2'b11         |
| 0xA4     | 输出电流组B                          | 状态帧     | 2'b11         |
| 0xA5     | 电池剩余电量组A                      | 状态帧     | 2'b00         |
| 0xA6     | 电池剩余电量组B                      | 状态帧     | 2'b00         |
| 0xA7     |                                      |            |               |
| 0xA8     |                                      |            |               |
| 0xA9     |                                      |            |               |
| 0xAA     |                                      |            |               |
| 0xAB     |                                      |            |               |
| 0xAC     |                                      |            |               |
| 0xAD     |                                      |            |               |
| 0xAE     |                                      |            |               |
| 0xAF     |                                      |            |               |

下面分别给出每种数据的存储格式和解算方法

### 0xA0

| 数据功能 | 电池组电压          | 电池输出功率    | 电池累计放电量   |
| -------- | ------------------- | --------------- | ---------------- |
| 数值范围 | uint16_t，单位0.01V | uint16_t，单位W | uint16_t，单位Ah |

### 0xA1

| 数据功能 | 电压校准参数     | 电压校准组 |
| -------- | ---------------- | ---------- |
| 数值范围 | float_t，单位1mV | uint16_t   |

### 0xA2

| 数据功能 | 电流校准参数     | 电流校准组 |
| -------- | ---------------- | ---------- |
| 数值范围 | float_t，单位1mA | uint16_t   |

### 0xA3

| 数据功能 | 输出电流采样A1     | 输出电流采样A2     | 输出电流采样A3     |
| -------- | ------------------ | ------------------ | ------------------ |
| 数值范围 | uint16_t，单位0.1A | uint16_t，单位0.1A | uint16_t，单位0.1A |

### 0xA4

| 数据功能 | 电池组剩余电量   | 已放电时间        | 剩余放电时间      |
| -------- | ---------------- | ----------------- | ----------------- |
| 数值范围 | uint16_t，单位Ah | uint16_t，单位min | uint16_t，单位min |

### 0xA5

| 数据功能 | 电池电量A1 | 电池电量A2 | 电池电量A3 | 电池电量A4 | 电池电量A5 | 电池电量A6 |
| -------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
| 数值范围 | uint8_t，  | uint8_t    | uint8_t    | uint8_t    | uint8_t    | uint8_t    |

输出百分比值

### 0xA6

| 数据功能 | 电池电量B1 | 电池电量B2 | 电池电量B3 | 电池电量B4 | 电池电量B5 | 电池电量B6 |
| -------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
| 数值范围 | uint8_t    | uint8_t    | uint8_t    | uint8_t    | uint8_t    | uint8_t    |

输出百分比值



## 0xB0 状态监测

状态监测子集包含对机器人本体电控系统和机械结构运行状态的数据回传。本指令子集没有任何指令包含在核心指令集内

状态监测子集提供的类型如下

| Opcode | 类型描述    | 帧特性 | 推荐使用的DLC |
| ------ | ----------- | ------ | ------------- |
| 0xB0   | 保留        | 状态帧 | 保留          |
| 0xB1   | 推进器组A   | 状态帧 | 2'b11         |
| 0xB2   | 推进器组B   | 状态帧 | 2'b11         |
| 0xB3   | 推进器组C   | 状态帧 | 2'b11         |
| 0xB4   | 推进器组D   | 状态帧 | 2'b11         |
| 0xB5   | 照明组A     | 状态帧 | 2'b11         |
| 0xB6   | 照明组B     | 状态帧 | 2'b11         |
| 0xB7   | XYZ三轴云台 | 状态帧 | 2'b11         |
| 0xB8   | 舵机组A     | 状态帧 | 2'b11         |
| 0xB9   | 舵机组B     | 状态帧 | 2'b11         |
| 0xBA   | 舵机组C     | 状态帧 | 2'b11         |
| 0xBB   | 保留        | 状态帧 | 保留          |
| 0xBC   | 保留        | 状态帧 | 保留          |
| 0xBD   | 保留        | 状态帧 | 保留          |
| 0xBE   | 保留        | 状态帧 | 保留          |
| 0xBF   | 保留        | 状态帧 | 保留          |

下面分别给出每种数据的存储格式和解算方法

### 0xB1

| 数据功能 | 推进器状态A1 | 推进器状态A2 | 推进器状态A3 |
| -------- | ------------ | ------------ | ------------ |
| 数值范围 | uint16_t     | uint16_t     | uint16_t     |

本帧数据应当在收到控制指令后回传

### 0xB2

| 数据功能 | 推进器状态B1 | 推进器状态B2 | 推进器状态B3 |
| -------- | ------------ | ------------ | ------------ |
| 数值范围 | uint16_t     | uint16_t     | uint16_t     |

本帧数据应当在收到控制指令后回传

### 0xB3

| 数据功能 | 推进器状态C1 | 推进器状态C2 | 推进器状态C3 |
| -------- | ------------ | ------------ | ------------ |
| 数值范围 | uint16_t     | uint16_t     | uint16_t     |

本帧数据应当在收到控制指令后回传

### 0xB4

| 数据功能 | 推进器状态D1 | 推进器状态D2 | 推进器状态D3 |
| -------- | ------------ | ------------ | ------------ |
| 数值范围 | uint16_t     | uint16_t     | uint16_t     |

本帧数据应当在收到控制指令后回传

### 0xB5

| 数据功能 | 照明状态A1 | 照明状态A2 | 照明状态A3 |
| -------- | ---------- | ---------- | ---------- |
| 数值范围 | uint16_t   | uint16_t   | uint16_t   |

本帧数据应当在收到控制指令后回传

### 0xB6

| 数据功能 | 照明状态B1 | 照明状态B2 | 照明状态B3 |
| -------- | ---------- | ---------- | ---------- |
| 数值范围 | uint16_t   | uint16_t   | uint16_t   |

本帧数据应当在收到控制指令后回传

### 0xB7

| 数据功能 | X轴云台状态 | Y轴云台状态 | Z轴云台状态 |
| -------- | ----------- | ----------- | ----------- |
| 数值范围 | uint16_t    | uint16_t    | uint16_t    |

本帧数据应当在收到控制指令后回传

### 0xB8

| 数据功能 | 舵机状态A1 | 舵机状态A2 | 舵机状态A3 |
| -------- | ---------- | ---------- | ---------- |
| 数值范围 | uint16_t   | uint16_t   | uint16_t   |

本帧数据应当在收到控制指令后回传

### 0xBA

| 数据功能 | 舵机状态B1 | 舵机状态B2 | 舵机状态B3 |
| -------- | ---------- | ---------- | ---------- |
| 数值范围 | uint16_t   | uint16_t   | uint16_t   |

本帧数据应当在收到控制指令后回传

### 0xBB

| 数据功能 | 舵机状态C1 | 舵机状态C2 | 舵机状态C3 |
| -------- | ---------- | ---------- | ---------- |
| 数值范围 | uint16_t   | uint16_t   | uint16_t   |

本帧数据应当在收到控制指令后回传



## 0xC0 扩展指令C

扩展指令集C用于用户定义自己的指令帧。本指令子集没有任何指令包含在核心指令集内

扩展指令集C提供的类型如下

| Opcode | 类型描述 | 帧特性 | 推荐使用的DLC |
| ------ | -------- | ------ | ------------- |
| 0xC0   |          |        |               |
| 0xC1   |          |        |               |
| 0xC2   |          |        |               |
| 0xC3   |          |        |               |
| 0xC4   |          |        |               |
| 0xC5   |          |        |               |
| 0xC6   |          |        |               |
| 0xC7   |          |        |               |
| 0xC8   |          |        |               |
| 0xC9   |          |        |               |
| 0xCA   |          |        |               |
| 0xCB   |          |        |               |
| 0xCC   |          |        |               |
| 0xCD   |          |        |               |
| 0xCE   |          |        |               |
| 0xCF   |          |        |               |

## 0xD0 扩展指令D

扩展指令集D用于用户定义自己的回传帧和状态帧。本指令子集没有任何指令包含在核心指令集内

扩展指令集D提供的类型如下

| Opcode | 类型描述 | 帧特性 | 推荐使用的DLC |
| ------ | -------- | ------ | ------------- |
| 0xD0   |          |        |               |
| 0xD1   |          |        |               |
| 0xD2   |          |        |               |
| 0xD3   |          |        |               |
| 0xD4   |          |        |               |
| 0xD5   |          |        |               |
| 0xD6   |          |        |               |
| 0xD7   |          |        |               |
| 0xD8   |          |        |               |
| 0xD9   |          |        |               |
| 0xDA   |          |        |               |
| 0xDB   |          |        |               |
| 0xDC   |          |        |               |
| 0xDD   |          |        |               |
| 0xDE   |          |        |               |
| 0xDF   |          |        |               |

## 0xE0 扩展指令/多媒体指令E

扩展指令集E用于用户定义自己的功能帧和心跳包。本指令子集没有任何指令包含在核心指令集内

在 RovLink1.3 版本后，扩展指令集E为 OurIPC 兼容设备提供多媒体指令集定义。

扩展指令集E提供的类型如下

| Opcode | 类型描述       | 帧特性 | 推荐使用的DLC |
| ------ | -------------- | ------ | ------------- |
| 0xE0   | 媒体码流参数   | 回传帧 | 2'b00         |
| 0xE1   | 相机参数       | 回传帧 | 2'b00         |
| 0xE2   | 音频码流参数   | 回传帧 | 2'b00         |
| 0xE3   | 麦克风参数     | 回传帧 | 2'b00         |
| 0xE4   |                |        |               |
| 0xE5   |                |        |               |
| 0xE6   | 存储状态       | 指令帧 | 2'b00         |
| 0xE7   | 录像状态       | 指令帧 | 2'b10         |
| 0xE8   |                |        |               |
| 0xE9   |                |        |               |
| 0xEA   | 多媒体功能开关 | 指令帧 | 2'b00         |
| 0xEB   |                |        |               |
| 0xEC   |                |        |               |
| 0xED   |                |        |               |
| 0xEE   |                |        |               |
| 0xEF   |                |        |               |

### 0xE0

该帧用于向上位机反馈当前设备是否正在推流，以及当前推流的码流参数

| 数据功能 | 设备号         | 编码方式 | 分辨率  | 帧率           | 预留    | 预留    |
| -------- | -------------- | -------- | ------- | -------------- | ------- | ------- |
| 数值范围 | uint8_t，1~255 | uint8_t  | uint8_t | uint8_t，0~255 | uint8_t | uint8_t |

设备号是当前设备的序号

编码方式表示当前视频码流的具体编码格式。可按照下表划分

| 编码格式  | Payload内容 |
| --------- | ----------- |
| H264/AVC  | 0x00        |
| H265/HEVC | 0x01        |
| JPEG      | 0x02        |
| MJPEG     | 0x03        |
| AVS1/AVS2 | 0x04        |
| AVS3      | 0x05        |
| ProRes    | 0x06        |
| 其他      | 0xFF        |

分辨率表示当前设备推流的分辨率，可分为：720P及以下（0x00）、1080P（0x01）、4K（0x02）、8K（0x03）、高于8K的其他分辨率（0x04）

帧率表示当前设备推流的帧率，若当前推流帧率超过标准240帧则一律以255表示

### 0xE1

该帧用于向上位机反馈当前相机Sensor的基本硬件参数

| 数据功能 | 设备号         | 数据格式 | 分辨率  | 帧率           | 画幅    | 预留    |
| -------- | -------------- | -------- | ------- | -------------- | ------- | ------- |
| 数值范围 | uint8_t，1~255 | uint8_t  | uint8_t | uint8_t，0~255 | uint8_t | uint8_t |

设备号是当前相机Sensor的序号。**若有两个及以上相机Sensor作为输入，设备必须重复发送该帧**，设备号唯一给出了后续硬件参数说明的对象

数据格式表示当前相机Sensor使用何种格式传输图像。可按照下表划分

| 编码格式       | Payload内容 |
| -------------- | ----------- |
| 8bit RGGB RAW  | 0x00        |
| 10bit RGGB RAW | 0x01        |
| AFBC           | 0x02        |
| RGB565         | 0x03        |
| RGB888         | 0x04        |
| YUV422         | 0x05        |
| YUV420         | 0x06        |
| 其他           | 0xFF        |

分辨率表示当前相机Sensor输入的像素数，可分为：100万及以下（0x00）、200万及以下（0x01）、500万及以下（0x02）、800万及以下（0x03）、1200万及以下（0x04）、高于1200万的其他分辨率（0x05）

帧率表示当前相机Sensor输入的帧率，若当前输入帧率超过标准240帧则一律以255表示

画幅表示当前相机Sensor的靶面尺寸。可按照下表划分

| 画幅     | Payload内容 |
| -------- | ----------- |
| ≥1''     | 0x00        |
| ≥1/1.2'' | 0x01        |
| ≥1/1.3'' | 0x02        |
| ≥1/1.8'' | 0x03        |
| ≥1/2.1'' | 0x04        |
| ≥1/3''   | 0x05        |
| ≥1/3.8'' | 0x06        |
| 其他     | 0x07        |

### 0xE6

该帧用于向上位机反馈当前设备的存储状态

| 数据功能 | 存储状态 | 预留    | 预留    | 预留    | 预留    | 预留    |
| -------- | -------- | ------- | ------- | ------- | ------- | ------- |
| 数值范围 | uint8_t  | uint8_t | uint8_t | uint8_t | uint8_t | uint8_t |

存储状态可分为：板载存储空间空闲（0x00）、存在空闲空间（0x01）、存在图片抓拍存储空间（0x02）、存在视频内录存储空间（0x03）

> 对于有内部存储的设备，在连接到上位机后会依次反馈发送板载存储空间空闲、存在空闲空间；若设备内录存储未满，则会反馈存在图片抓拍存储空间、存在视频内录存储空间

### 0xE7

该帧用于向上位机反馈当前设备的录像状态

| 数据功能 | 录像时间 | 录像状态 |
| -------- | -------- | -------- |
| 数值范围 | uint32_t | uint16_t |

录像状态为0x01表示正在录像；为0x00表示停止录像

录像时间为当前时刻与开始录像时刻的时间差（单位秒）

### 0xEA

该帧用于控制相机的多媒体功能

| 数据功能 | 多媒体指令类型 | 指令字  | 扩展指令字 | 预留    | 预留    | 预留    |
| -------- | -------------- | ------- | ---------- | ------- | ------- | ------- |
| 数值范围 | uint8_t        | uint8_t | uint8_t    | uint8_t | uint8_t | uint8_t |

该帧通过多媒体指令类型来指定具体要控制的多媒体功能，具体内容如下表

| 多媒体指令类型 | 要控制的多媒体功能                                           | 备注                           |
| -------------- | ------------------------------------------------------------ | ------------------------------ |
| 0x00           | 开关录像                                                     |                                |
| 0x01           | 启动一次抓拍                                                 | 必须使用0x02指令字             |
| 0x02           | 切换白天/夜视模式                                            | 必须使用0x02指令字             |
| 0x03           | 切换默认AI算法                                               | 必须使用0x02指令字             |
| 0x04           | 预留                                                         |                                |
| 0x05           | 预留                                                         |                                |
| 0x06           | 切换相机模式（单目1、单目2、单目3、单目4、双目拼接、四目拼接） | 必须使用0x02指令字和扩展指令字 |

该帧中指令字代表上位机要对选定的多媒体功能执行哪些操作，具体内容如下表

| 指令字 | 具体操作 |
| ------ | -------- |
| 0x00   | 关闭功能 |
| 0x01   | 打开功能 |
| 0x02   | 切换功能 |

该帧中扩展指令字用于配合指令字来确定某些参数

## 0xF0 兼容指令

兼容指令子集包含用于和其他指令集（包括但不限于上一代ROV控制协议、MAVLink等）对接兼容的数据。本指令子集没有任何指令包含在核心指令集内

兼容指令子集提供的类型如下

| Opcode | 类型描述             | 帧特性 | 推荐使用的DLC |
| ------ | -------------------- | ------ | ------------- |
| 0xF0   |                      |        |               |
| 0xF1   |                      |        |               |
| 0xF2   |                      |        |               |
| 0xF3   |                      |        |               |
| 0xF4   |                      |        |               |
| 0xF5   |                      |        |               |
| 0xF6   |                      |        |               |
| 0xF7   |                      |        |               |
| 0xF8   |                      |        |               |
| 0xF9   |                      |        |               |
| 0xFA   |                      |        |               |
| 0xFB   |                      |        |               |
| 0xFC   |                      |        |               |
| 0xFD   |                      |        |               |
| 0xFE   | 冒号分隔字符串数据   | 未定义 | 未定义        |
| 0xFF   | 上一代ROV-Legacy协议 | 未定义 | 未定义        |

### 0xFF

| 数据功能 | 空     | 空     | 空     |
| -------- | ------ | ------ | ------ |
| 数值范围 | 0x0000 | 0x0000 | 0x0000 |

在下位机收到本帧数据后，应当采用Legacy协议接收指令和发送数据帧；在上位机收到本帧数据后，应当采用Legacy协议接收和发送

### 0xFE

| 数据功能 | 空     | 空     | 空     |
| -------- | ------ | ------ | ------ |
| 数值范围 | 0x0000 | 0x0000 | 0x0000 |

在上位机收到本帧数据后，应当采用冒号分隔明文字符串协议接收MCU回传的控制台数据；下位机不应接收本帧数据

本帧用于实现 CoralReef 上位机、控制台 MCU 和 RovLink 设备之间的通信兼容
